syntax = "proto3";

package ingestion;

option go_package = ".;proto_gen";

// InternalIngestionService provides an API for the main backend to read
// spans from the SQLite WAL.
service InternalIngestionService {
  // ReadSpans reads a batch of spans from the WAL, starting after the
  // specified ULID. This is a server-streaming RPC.
  rpc ReadSpans(ReadSpansRequest) returns (stream ReadSpansResponse) {}

  // GetWALSpansByTraceId returns all spans in the WAL matching a trace ID.
  // Used for fusion queries combining WAL and Parquet data.
  rpc GetWALSpansByTraceId(GetWALSpansByTraceIdRequest) returns (stream SpanData) {}

  // GetWALDistinctServiceNames returns all distinct service names currently in the WAL.
  // Used to merge with Parquet-indexed services for complete listing.
  rpc GetWALDistinctServiceNames(GetWALDistinctServiceNamesRequest) returns (GetWALDistinctServiceNamesResponse) {}

  // GetWALRootSpans returns root spans (no parent) from the WAL for a service.
  // Used for trace listing, merged with Parquet root spans.
  rpc GetWALRootSpans(GetWALRootSpansRequest) returns (stream SpanData) {}
}

// ReadSpansRequest defines the parameters for requesting a batch of spans.
message ReadSpansRequest {
  // The ULID of the last span successfully processed by the client.
  // The server will return spans that were received *after* this key.
  // If empty, the stream will start from the oldest available span.
  bytes start_key_ulid = 1;

  // The maximum number of spans to return in the batch.
  uint32 batch_size = 2;
}

// ReadSpansResponse contains a single span from the WAL.
message ReadSpansResponse {
  // The ULID key of the span, which also serves as its timestamp.
  bytes key_ulid = 1;

  // The raw, serialized protobuf bytes of the OTel span.
  bytes span_bytes = 2;

  // The raw, serialized protobuf bytes of the OTel resource.
  bytes resource_bytes = 3;

  // The number of spans remaining in the WAL after this batch was retrieved.
  // This count is decremented atomically when the batch is read.
  uint64 remaining_count = 4;
}

// ============================================================================
// WAL Query Messages (for fusion queries)
// ============================================================================

// SpanData contains a fully decoded span with all fields extracted.
// Used for query responses where the caller needs structured data.
message SpanData {
  string span_id = 1;
  string trace_id = 2;
  string parent_span_id = 3;
  string service_name = 4;
  string name = 5;
  int32 span_kind = 6;
  int64 start_time_unix_nano = 7;
  int64 end_time_unix_nano = 8;
  int64 duration_ns = 9;
  int32 status_code = 10;
  string status_message = 11;
  string attributes_json = 12;  // JSON-encoded attributes
  string events_json = 13;      // JSON-encoded events
  string resource_attributes_json = 14;  // JSON-encoded resource attributes
}

// GetWALSpansByTraceIdRequest requests all spans matching a trace ID.
message GetWALSpansByTraceIdRequest {
  string trace_id = 1;
}

// GetWALDistinctServiceNamesRequest requests all distinct service names in WAL.
message GetWALDistinctServiceNamesRequest {
  // Empty - no parameters needed
}

// GetWALDistinctServiceNamesResponse contains the list of service names.
message GetWALDistinctServiceNamesResponse {
  repeated string service_names = 1;
}

// GetWALRootSpansRequest requests root spans for a service.
message GetWALRootSpansRequest {
  string service_name = 1;
  int32 limit = 2;  // Maximum number of root spans to return
}
