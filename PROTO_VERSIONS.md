# Protocol Buffer Tool Versions

This document specifies the **locked versions** of Protocol Buffer tools used for **Python code generation** in Junjo AI Studio.

> **Note:** The Rust ingestion service generates proto code at **build time** via `build.rs` using `tonic-prost-build`. No manual proto generation or version locking is needed for Rust.

## Required Tool Versions

| Tool | Version | Purpose |
|------|---------|---------|
| **protoc** | v30.2 | Protocol Buffer compiler (for Python) |
| **grpcio-tools** | 1.76.0 | Python protobuf/gRPC code generator |

## Proto Generation by Language

### Python (Backend) - Manual Generation, Committed to Git

Python proto files are:
- Generated manually via `./scripts/generate_proto.sh`
- Committed to git (`backend/app/proto_gen/*.py`)
- Must be regenerated when `.proto` files change

**Why version locking matters:** Different `protoc` versions generate structurally different code. Locking ensures identical code across all environments.

### Rust (Ingestion) - Build-time Generation, Not Committed

Rust proto files are:
- Generated automatically at compile time via `build.rs`
- Placed in `target/` directory (gitignored)
- Regenerated fresh on every `cargo build`

**No version locking needed:** Every build regenerates protos from source. There's no committed generated code that could become stale.

```rust
// ingestion/build.rs
fn main() -> Result<(), Box<dyn std::error::Error>> {
    tonic_prost_build::configure()
        .compile_protos(
            &["../proto/ingestion.proto", "../proto/auth.proto"],
            &["../proto"],
        )?;
    Ok(())
}
```

## Understanding Version Numbers

### Protoc Dual Versioning

**Protoc uses dual versioning:**
- **Release version**: `v30.2` (what you download/install, shown by `protoc --version`)
- **Full semantic version**: `v6.30.2` (shown in generated file headers)

Both refer to the same version.

### What You'll See Where

**Installation/CLI output:**
```bash
$ protoc --version
libprotoc 30.2  # Shows minor.patch only
```

**Generated Python files (header comment):**
```python
# Generated by the protocol buffer compiler.  DO NOT EDIT!
# source: auth.proto
# Protobuf Python Version: 6.31.1  ← Runtime library version (NOT compiler!)
```

### Important Notes

✅ **Python files showing `Protobuf Python Version: 6.31.1` is CORRECT** - this is the protobuf Python **runtime library** version (from `protobuf` package), NOT the protoc compiler version

✅ **Python runtime version can differ from protoc version** - grpcio-tools 1.76.0 bundles protoc v30.2 (compiler) but generates code for protobuf 6.31.1 (runtime). This is normal.

❌ **If `protoc --version` shows anything other than `30.2`**, you need to install the correct version

## Installation Instructions

### macOS

**Install protoc v30.2:**
```bash
PROTOC_VERSION=30.2
curl -LO https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/protoc-${PROTOC_VERSION}-osx-x86_64.zip
sudo unzip -o protoc-${PROTOC_VERSION}-osx-x86_64.zip -d /usr/local bin/protoc
sudo unzip -o protoc-${PROTOC_VERSION}-osx-x86_64.zip -d /usr/local 'include/*'
rm protoc-${PROTOC_VERSION}-osx-x86_64.zip
```

**Install Python tools (via uv):**
```bash
cd backend
uv sync  # Installs grpcio-tools==1.76.0 from uv.lock
```

### Linux

**Install protoc v30.2:**
```bash
PROTOC_VERSION=30.2
curl -LO https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/protoc-${PROTOC_VERSION}-linux-x86_64.zip
sudo unzip -o protoc-${PROTOC_VERSION}-linux-x86_64.zip -d /usr/local bin/protoc
sudo unzip -o protoc-${PROTOC_VERSION}-linux-x86_64.zip -d /usr/local 'include/*'
rm protoc-${PROTOC_VERSION}-linux-x86_64.zip
```

**Install Python tools (via uv):**
```bash
cd backend
uv sync  # Installs grpcio-tools==1.76.0 from uv.lock
```

### Windows

**Install protoc v30.2:**
```powershell
$PROTOC_VERSION = "30.2"
Invoke-WebRequest -Uri "https://github.com/protocolbuffers/protobuf/releases/download/v$PROTOC_VERSION/protoc-$PROTOC_VERSION-win64.zip" -OutFile "protoc.zip"
Expand-Archive -Path protoc.zip -DestinationPath "C:\protoc" -Force
# Add C:\protoc\bin to your PATH
Remove-Item protoc.zip
```

**Install Python tools (via uv):**
```powershell
cd backend
uv sync  # Installs grpcio-tools==1.76.0 from uv.lock
```

## Verification

After installation, verify versions:

```bash
protoc --version
# Expected: libprotoc 30.2

# For Python (from backend directory with uv environment active)
uv run python -m grpc_tools.protoc --version
# Expected: libprotoc 30.2 (bundled with grpcio-tools)
```

## Regenerating Proto Files

### Python (Backend)

```bash
cd backend
./scripts/generate_proto.sh
```

### Rust (Ingestion)

No manual regeneration needed. Proto files are generated automatically during:
```bash
cargo build
cargo check
cargo run
```

### Automated via Pre-commit Hook

The pre-commit hook automatically regenerates Python proto files before each commit:
- Regenerates `backend/app/proto_gen/*.py` files
- Stages updated files automatically
- Prevents commits with stale Python proto code

## CI/CD Integration

### Python Proto Validation

The `.github/workflows/proto-staleness-check.yml` workflow:
1. Regenerates Python proto files from scratch
2. Runs `git diff` to check for changes
3. Fails the build if any differences are detected

### Rust Proto Validation

The same workflow runs `cargo check` in the ingestion directory to verify:
1. Proto files compile successfully
2. `build.rs` correctly references shared `proto/` directory

## Troubleshooting

### "protoc: command not found"
- Ensure protoc is in your PATH
- Verify installation with `which protoc`

### Generated Python code differs from committed files
- Ensure you have protoc v30.2 installed (not from Homebrew)
- Regenerate: `cd backend && ./scripts/generate_proto.sh`
- If using Homebrew's protoc, uninstall it: `brew uninstall protobuf`

### CI validation fails with "Proto files are out of date"
- Your local protoc version differs from v30.2
- Install v30.2 manually (do not use package managers)
- Regenerate proto files locally
- Commit the updated files

### Rust build fails with proto errors
- Ensure `proto/` directory exists at repository root
- Check `ingestion/build.rs` references correct paths
- Run `cargo clean && cargo build` to regenerate

## Version Update Process

When updating protoc version:

1. Update version numbers in this file
2. Update `.github/workflows/proto-staleness-check.yml`
3. Regenerate Python proto files locally
4. Test that Rust `cargo build` still works
5. Commit all updated files in a single commit
6. Notify developers to update their local installations

## References

- [Protocol Buffers Official Site](https://protobuf.dev/)
- [protoc Releases](https://github.com/protocolbuffers/protobuf/releases)
- [grpcio-tools PyPI](https://pypi.org/project/grpcio-tools/)
- [tonic-prost-build (Rust)](https://docs.rs/tonic-build/latest/tonic_build/)
